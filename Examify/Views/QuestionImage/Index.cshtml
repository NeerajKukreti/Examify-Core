@{
    ViewData["Title"] = "Upload Question Images";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-images"></i> Upload Question Images</h4>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success">@TempData["Success"]</div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    <div class="alert alert-info">
                        <strong>Quick Paste:</strong> Copy image from PDF (Ctrl+C) and paste below (Ctrl+V)
                    </div>

                    <div class="form-group">
                        <label><strong>Paste Image from Clipboard</strong></label>
                        <div id="pasteArea" class="border p-4 text-center" style="min-height: 200px; background: #f8f9fa; cursor: pointer;" tabindex="0">
                            <p class="text-muted">Click here and press Ctrl+V to paste copied image</p>
                            <div id="pastedImages" class="row"></div>
                        </div>
                    </div>

                    <hr class="my-4" />
                    <p class="text-center text-muted">OR</p>
                    <hr class="my-4" />

                    <form asp-action="UploadImages" method="post" enctype="multipart/form-data" id="uploadForm">
                        <div class="form-group">
                            <label><strong>Select Question Images from Files</strong></label>
                            <input type="file" name="images" id="fileInput" class="form-control-file" accept="image/*" multiple />
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-upload"></i> Upload Images
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let pastedFiles = [];

document.getElementById('pasteArea').addEventListener('paste', function(e) {
    e.preventDefault();
    const items = e.clipboardData.items;
    
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = 'img-thumbnail m-2';
                img.style.maxWidth = '200px';
                
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-2';
                col.appendChild(img);
                
                document.getElementById('pastedImages').appendChild(col);
                pastedFiles.push(blob);
                
                document.getElementById('uploadBtn').disabled = false;
            };
            
            reader.readAsDataURL(blob);
        }
    }
});

document.getElementById('pasteArea').addEventListener('click', function() {
    this.focus();
});

document.getElementById('fileInput').addEventListener('change', function() {
    if (this.files.length > 0) {
        document.getElementById('uploadBtn').disabled = false;
    }
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    if (pastedFiles.length > 0) {
        e.preventDefault();
        
        const formData = new FormData();
        pastedFiles.forEach((file, index) => {
            formData.append('images', file, `pasted_${index}.png`);
        });
        
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('images', fileInput.files[i]);
            }
        }
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                response.text().then(() => {
                    window.location.reload();
                });
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Upload failed. Please try again.');
        });
    }
});
</script>
